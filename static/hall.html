<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>명예의 전당 - 하루 한 개 질문 챌린지</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'pastel-orange': '#FFB87A',
                    'pastel-coral': '#FF9B9B',
                    'pastel-yellow': '#FFE78A',
                    'pastel-green': '#8FE6B0',
                    'pastel-sky': '#8FC9F9',
                    'pastel-purple': '#C5B5E8',
                    'cream': '#FFFBF5',
                    'cream-dark': '#FFF3E0',
                    'txt': '#2D2424',
                    'txt-light': '#5C4E4E',
                    'txt-lighter': '#8E7E7E',
                },
                fontFamily: {
                    heading: ['"Jua"', 'sans-serif'],
                    body: ['"Gowun Dodum"', 'sans-serif'],
                }
            }
        }
    }
    </script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="font-body bg-cream text-txt min-h-screen antialiased">
    <div class="min-h-screen">
        <header class="hall-header text-center py-10 px-5 relative">
            <a href="/" class="absolute top-3.5 left-4 bg-white/10 border border-white/20 rounded-lg px-3 py-1.5 text-sm font-bold no-underline text-[#FFD700]/80 hover:bg-white/20 hover:text-[#FFD700] transition z-10">&lt; 돌아가기</a>
            <div class="relative z-10">
                <div class="hall-crown text-4xl mb-1 font-heading">&#9733;</div>
                <h1 class="hall-title font-heading text-4xl sm:text-5xl tracking-wide">명예의 전당</h1>
                <div class="hall-divider w-40 mx-auto mt-3 mb-2.5"></div>
                <p class="text-sm text-[#FFD700]/60 font-semibold tracking-wider">누적 질문 수로 보는 우리 학교 질문왕!</p>
            </div>
        </header>

        <div class="max-w-[600px] mx-auto p-4">
            <!-- Rank Cards for Top 3 -->
            <div id="podium" class="flex flex-col gap-4 mb-6"></div>

            <!-- Full Ranking -->
            <div class="flex items-center gap-2 mb-3 mt-2">
                <span class="font-heading text-base font-bold">전체 순위</span>
                <span id="hall-total" class="text-xs bg-cream-dark text-[#A04800] px-3 py-0.5 rounded-full font-bold">0명</span>
            </div>
            <div id="hall-list" class="flex flex-col gap-2"></div>

            <div id="hall-empty" class="text-center py-12 px-5" style="display:none">
                <div class="text-5xl font-heading text-pastel-yellow mb-3">?</div>
                <p class="text-base font-bold text-txt-light">아직 순위가 없어요</p>
                <p class="text-sm text-txt-lighter mt-1">질문을 올리면 명예의 전당에 이름이 올라가요!</p>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const gradeClasses = { 1: 'grade-1', 2: 'grade-2', 3: 'grade-3', 4: 'grade-4', 5: 'grade-5', 6: 'grade-6' };

        const rankColors = {
            1: { card: 'rank-card-1', badge: 'rank-badge-1' },
            2: { card: 'rank-card-2', badge: 'rank-badge-2' },
            3: { card: 'rank-card-3', badge: 'rank-badge-3' },
        };

        async function loadHallOfFame() {
            try {
                const res = await fetch('/api/hall-of-fame');
                const data = await res.json();

                if (!res.ok) {
                    if (res.status === 401) { window.location.href = '/'; return; }
                    throw new Error(data.error);
                }

                const ranking = data.ranking;
                document.getElementById('hall-total').textContent = `${ranking.length}명`;

                if (ranking.length === 0) {
                    document.getElementById('hall-empty').style.display = 'block';
                    return;
                }

                // Build podium cards for ranks 1, 2, 3
                const podiumHTML = [1, 2, 3].map(rank => {
                    const students = ranking.filter(s => s.rank === rank);
                    if (students.length === 0) return '';

                    const count = students[0].question_count;
                    const colors = rankColors[rank];
                    const rankLabel = rank + '등';
                    const listId = `rank-${rank}-list`;

                    const namesHTML = students.map(s => `
                            <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-white shadow-sm ${s.is_me ? 'ring-2 ring-pastel-orange' : ''}">
                                <span class="text-xs text-txt-light">${s.grade}-${s.class_num}</span>
                                ${escapeHtml(s.name)}
                            </span>
                        `).join('');

                    return `
                    <div class="rounded-2xl p-5 text-center border-2 ${colors.card}">
                        <div class="flex items-center justify-center gap-2.5 mb-2">
                            <span class="inline-block px-7 py-2 rounded-full text-2xl font-heading font-bold ${colors.badge}">${rankLabel}</span>
                            <span class="text-sm text-txt-light font-semibold">(${students.length}명)</span>
                        </div>
                        <div class="text-4xl font-heading font-bold text-txt mb-3">
                            ${count}<span class="text-base font-body text-txt-light ml-1">질문</span>
                        </div>
                        <div class="flex flex-wrap justify-center gap-2">
                            ${namesHTML}
                        </div>
                    </div>`;
                }).join('');

                document.getElementById('podium').innerHTML = podiumHTML;

                // Full list (rank 4+ only, since 1-3 shown in cards)
                const rank4Plus = ranking.filter(s => s.rank > 3);
                document.getElementById('hall-list').innerHTML = rank4Plus.map((s, i) => `
                    <div class="flex items-center gap-3 bg-white px-4 py-3.5 rounded-2xl shadow-sm animate-slideUp border border-[#FFE8CC]/20 ${s.is_me ? 'ring-2 ring-pastel-orange bg-cream' : ''}" style="animation-delay:${i * 0.03}s">
                        <div class="text-txt-light font-bold min-w-[30px] text-center font-heading">${s.rank}</div>
                        <div class="w-9 h-9 rounded-full flex items-center justify-center text-sm font-bold text-white ${gradeClasses[s.grade]}">${s.grade}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-bold">${s.grade}-${s.class_num} ${escapeHtml(s.name)}${s.is_me ? ' (나)' : ''}</div>
                            <div class="text-xs text-txt-light">${s.grade}학년 ${s.class_num}반</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-heading font-bold text-[#A04800]">${s.question_count}</div>
                            <div class="text-xs text-txt-light">질문</div>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error(err);
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHallOfFame();
            // 30초마다 자동 새로고침
            setInterval(loadHallOfFame, 30000);
            // 탭으로 돌아올 때 즉시 새로고침
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) loadHallOfFame();
            });
        });
    </script>
</body>
</html>
